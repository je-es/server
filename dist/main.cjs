'use strict';Object.defineProperty(exports,'__esModule',{value:true});var ee=require('@je-es/sdb'),re=require('crypto'),slog=require('@je-es/slog'),path=require('path'),fs=require('fs');function _interopDefault(e){return e&&e.__esModule?e:{default:e}}function _interopNamespace(e){if(e&&e.__esModule)return e;var n=Object.create(null);if(e){Object.keys(e).forEach(function(k){if(k!=='default'){var d=Object.getOwnPropertyDescriptor(e,k);Object.defineProperty(n,k,d.get?d:{enumerable:true,get:function(){return e[k]}});}})}n.default=e;return Object.freeze(n)}var ee__namespace=/*#__PURE__*/_interopNamespace(ee);var re__default=/*#__PURE__*/_interopDefault(re);var O=class{constructor(){this.routes=new Map;this.regexRoutes=[];}match(e,r){let t=`${e}:${r}`;if(this.routes.has(t))return {handler:this.routes.get(t),params:{}};for(let s of this.regexRoutes)if(s.method===e){let o=r.match(s.pattern);if(o){let c=o.groups||{};return {handler:s.handler,params:c}}}return null}getAll(){let e=Array.from(this.routes.entries()).map(([t,s])=>{let o=t.indexOf(":"),c=t.substring(0,o),a=t.substring(o+1);return {method:c,path:a,handler:s}}),r=this.regexRoutes.map(t=>{let s=t.key.indexOf(":");return {method:t.method,path:t.key.substring(s+1),handler:t.handler}});return [...e,...r]}clear(){this.routes.clear(),this.regexRoutes=[];}remove(e,r){let t=`${e}:${r}`;if(this.routes.has(t))return this.routes.delete(t),true;let s=this.regexRoutes.findIndex(o=>o.key===t);return s>=0?(this.regexRoutes.splice(s,1),true):false}register(e,r,t,s={}){let o=`${e}:${r}`;if(r.includes(":")||r.includes("*")){let c=this.pathToRegex(r),a=this.regexRoutes.findIndex(h=>h.key===o),m={pattern:c,method:e,handler:t,key:o};a>=0?this.regexRoutes[a]=m:this.regexRoutes.push(m);}else this.routes.set(o,t);}pathToRegex(e){let r=e.replace(/[.+?^${}()|[\]\\]/g,"\\$&");return r=r.replace(/:(\w+)/g,"(?<$1>[^/]+)"),r=r.replace(/\*/g,".*"),new RegExp(`^${r}$`)}};var j=class{constructor(){this.rateLimitStore=new Map;this.csrfTokens=new Map;this.requestLog=new Map;this.MAX_REQUEST_LOG_SIZE=1e3;}checkRateLimit(e,r,t){let s=Date.now(),o=this.rateLimitStore.get(e);return o?s<o.reset?o.count>=r?false:(o.count++,true):(this.rateLimitStore.set(e,{count:1,reset:s+t}),true):(this.rateLimitStore.set(e,{count:1,reset:s+t}),true)}cleanupRateLimit(){let e=Date.now();for(let[r,t]of this.rateLimitStore.entries())e>t.reset&&this.rateLimitStore.delete(r);}generateCsrfToken(e,r=36e5){let t=re__default.default.randomBytes(32).toString("hex");return this.csrfTokens.set(t,{sessionId:e,expires:Date.now()+r}),t}validateCsrfToken(e,r){let t=this.csrfTokens.get(e);return t?Date.now()>t.expires?(this.csrfTokens.delete(e),false):t.sessionId===r?(this.csrfTokens.delete(e),true):false:false}cleanupCsrfTokens(){let e=Date.now();for(let[r,t]of this.csrfTokens.entries())e>t.expires&&this.csrfTokens.delete(r);}sanitizeHtml(e){return e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;"):""}sanitizeSql(e){return e?e.replace(/\\/g,"\\\\").replace(/;/g,"").replace(/'/g,"''").replace(/"/g,'\\"').replace(/\u0000/g,""):""}logRequest(e,r,t,s,o,c){if(this.requestLog.set(e,{timestamp:new Date().toISOString(),method:r,path:t,ip:s,status:o,duration:c}),this.requestLog.size>this.MAX_REQUEST_LOG_SIZE){let{value:a}=this.requestLog.keys().next()||{value:null};a&&this.requestLog.delete(a);}}getRequestLog(e){return this.requestLog.get(e)}getAllRequestLogs(){return Array.from(this.requestLog.values())}clearAll(){this.rateLimitStore.clear(),this.csrfTokens.clear(),this.requestLog.clear();}getStats(){return {rateLimitEntries:this.rateLimitStore.size,csrfTokens:this.csrfTokens.size,requestLogs:this.requestLog.size}}};var T=class extends Error{constructor(r,t=500,s){super(r);this.message=r;this.statusCode=t;this.code=s;this.name="AppError";}},k=class extends T{constructor(r,t){super(r,400,"VALIDATION_ERROR");this.issues=t;this.name="ValidationError";}},K=class extends T{constructor(e){super(e,500,"DATABASE_ERROR"),this.name="DatabaseError";}},z=class extends T{constructor(e="Request timeout"){super(e,408,"TIMEOUT_ERROR"),this.name="TimeoutError";}},Z=class extends T{constructor(e="Too many requests"){super(e,429,"RATE_LIMIT_ERROR"),this.name="RateLimitError";}};var q=class{constructor(e){this.fileCache=new Map;this.CACHE_MAX_SIZE=1e3;if(!fs.existsSync(e.directory))throw new Error(`Static directory does not exist: ${e.directory}`);if(!fs.statSync(e.directory).isDirectory())throw new Error(`Static path is not a directory: ${e.directory}`);this.resolvedDir=path.resolve(e.directory),this.config={path:e.path,directory:e.directory,maxAge:e.maxAge??3600,index:e.index??["index.html"],dotfiles:e.dotfiles??"deny",etag:e.etag??true,lastModified:e.lastModified??true,immutable:e.immutable??false,extensions:e.extensions??[],fallthrough:e.fallthrough??false,setHeaders:e.setHeaders};}handler(){return async e=>{let r=e.request.url,s=new URL(r).pathname;s.startsWith(this.config.path)&&(s=s.slice(this.config.path.length));try{s=decodeURIComponent(s);}catch{return e.json({error:"Invalid URL encoding"},400)}if(s.includes("..")||s.includes("\\"))return e.json({error:"Forbidden"},403);if(this.config.dotfiles!=="allow"&&s.split("/").some(a=>a.startsWith(".")))return this.config.dotfiles==="deny"?e.json({error:"Forbidden"},403):this.handleNotFound(e);let o=this.resolveFilePath(s);if(!o)return this.handleNotFound(e);if(!this.isPathSafe(o))return e.json({error:"Forbidden"},403);if(!fs.existsSync(o))return this.handleNotFound(e);let c=fs.statSync(o);return c.isDirectory()?this.serveDirectory(e,o,s):this.serveFile(e,o,c)}}getPathPattern(){return `${this.config.path}/*`}resolveFilePath(e){e.startsWith("/")&&(e=e.slice(1));let r=path.join(this.resolvedDir,e);if(!fs.existsSync(r)&&this.config.extensions.length>0)for(let t of this.config.extensions){let s=`${r}.${t}`;if(fs.existsSync(s))return s}return r}isPathSafe(e){return !path.relative(this.resolvedDir,path.resolve(e)).startsWith("..")&&!path.resolve(e).startsWith("..")}async serveDirectory(e,r,t){for(let s of this.config.index){let o=path.join(r,s);if(fs.existsSync(o)){let c=fs.statSync(o);if(c.isFile())return this.serveFile(e,o,c)}}return this.handleNotFound(e)}async serveFile(e,r,t){let s=e.request.method.toUpperCase();if(s!=="GET"&&s!=="HEAD")return e.json({error:"Method not allowed"},405);let o=r,c=this.fileCache.get(o);if(c&&c.mtime!==t.mtimeMs&&(c=void 0),!c){if(c={etag:this.generateEtag(t),lastModified:new Date(t.mtime),size:t.size,mtime:t.mtimeMs},this.fileCache.size>=this.CACHE_MAX_SIZE){let A=this.fileCache.keys().next().value;A&&this.fileCache.delete(A);}this.fileCache.set(o,c);}let a=e.request.headers.get("if-none-match"),m=e.request.headers.get("if-modified-since");if(this.config.etag&&a===c.etag)return new Response(null,{status:304,headers:this.buildHeaders(r,c)});if(this.config.lastModified&&m){let A=new Date(m);if(c.lastModified<=A)return new Response(null,{status:304,headers:this.buildHeaders(r,c)})}let h=Bun.file(r),y=this.buildHeaders(r,c);return this.config.setHeaders&&this.config.setHeaders(e,r),s==="HEAD"?new Response(null,{status:200,headers:y}):new Response(h,{status:200,headers:y})}buildHeaders(e,r){let t=new Headers,s=this.getMimeType(e);if(t.set("Content-Type",s),t.set("Content-Length",r.size.toString()),this.config.etag&&t.set("ETag",r.etag),this.config.lastModified&&t.set("Last-Modified",r.lastModified.toUTCString()),this.config.maxAge>0){let o=`public, max-age=${this.config.maxAge}`;this.config.immutable&&(o+=", immutable"),t.set("Cache-Control",o);}else t.set("Cache-Control","no-cache");return t.set("Accept-Ranges","bytes"),t}generateEtag(e){return `"${e.size.toString(16)}-${e.mtimeMs.toString(16)}"`}getMimeType(e){let r=path.extname(e).toLowerCase();return ae[r]||"application/octet-stream"}handleNotFound(e){return this.config.fallthrough?e.json({error:"Not Found"},404):e.json({error:"Not Found"},404)}clearCache(){this.fileCache.clear();}getCacheStats(){return {entries:this.fileCache.size,maxSize:this.CACHE_MAX_SIZE}}};function ie(n){return new q(n)}var ae={".html":"text/html; charset=utf-8",".htm":"text/html; charset=utf-8",".css":"text/css; charset=utf-8",".txt":"text/plain; charset=utf-8",".xml":"text/xml; charset=utf-8",".csv":"text/csv; charset=utf-8",".md":"text/markdown; charset=utf-8",".js":"application/javascript; charset=utf-8",".mjs":"application/javascript; charset=utf-8",".json":"application/json; charset=utf-8",".jsonld":"application/ld+json",".map":"application/json; charset=utf-8",".png":"image/png",".jpg":"image/jpeg",".jpeg":"image/jpeg",".gif":"image/gif",".svg":"image/svg+xml",".ico":"image/x-icon",".webp":"image/webp",".avif":"image/avif",".bmp":"image/bmp",".tiff":"image/tiff",".woff":"font/woff",".woff2":"font/woff2",".ttf":"font/ttf",".otf":"font/otf",".eot":"application/vnd.ms-fontobject",".mp3":"audio/mpeg",".wav":"audio/wav",".ogg":"audio/ogg",".m4a":"audio/mp4",".aac":"audio/aac",".flac":"audio/flac",".mp4":"video/mp4",".webm":"video/webm",".ogv":"video/ogg",".mov":"video/quicktime",".avi":"video/x-msvideo",".mkv":"video/x-matroska",".pdf":"application/pdf",".doc":"application/msword",".docx":"application/vnd.openxmlformats-officedocument.wordprocessingml.document",".xls":"application/vnd.ms-excel",".xlsx":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",".ppt":"application/vnd.ms-powerpoint",".pptx":"application/vnd.openxmlformats-officedocument.presentationml.presentation",".zip":"application/zip",".rar":"application/x-rar-compressed",".7z":"application/x-7z-compressed",".tar":"application/x-tar",".gz":"application/gzip",".wasm":"application/wasm",".manifest":"text/cache-manifest",".webmanifest":"application/manifest+json"};var F=new j,C=new O;function ue(n={}){let e=Number(n.port)||3e3,r=n.hostname||"localhost",t=n.maxRequestSize||10*1024*1024,s=n.requestTimeout||3e4,o=n.gracefulShutdownTimeout||1e4,c=typeof n.logging=="object"?n.logging:{},a=n.logging?new slog.Logger(c.level||"info",c.pretty):null,m=new Map,h=[],y=new Set,A=setInterval(()=>{F.cleanupRateLimit(),F.cleanupCsrfTokens();},120*1e3);async function H(i,d){let p=Date.now(),l=crypto.randomUUID(),S=new URL(i.url).pathname,L=i.method.toUpperCase(),w=pe(i,d);y.add(l);try{let b=i.headers.get("content-length");if(b&&parseInt(b)>t)return a?.warn({requestId:l,size:b,ip:w},"Request too large"),new Response(JSON.stringify({error:"Payload too large"}),{status:413,headers:{"Content-Type":"application/json"}});let I=ge(i,n);if(L==="OPTIONS")return new Response(null,{status:204,headers:I});if(n.security&&typeof n.security=="object"&&n.security.rateLimit){let v=typeof n.security.rateLimit=="object"?n.security.rateLimit:{},D=v.max||100,_=v.windowMs||6e4,J=v.keyGenerator?v.keyGenerator({request:i,ip:w}):w;if(!F.checkRateLimit(J,D,_))return a?.warn({requestId:l,ip:w,key:J},"Rate limit exceeded"),new Response(JSON.stringify({error:v.message||"Too many requests"}),{status:429,headers:{"Content-Type":"application/json"}})}let B=null;["POST","PUT","PATCH"].includes(L)&&(B=await de(i,a,t));let V=m.get("default"),$=C.match(L,S);if(!$){let v=Y(w,i,{},V,a,l);return a?.warn({requestId:l,method:L,path:S,ip:w},"Route not found"),v.json({error:"Not Found",path:S},404)}let N=Y(w,i,$.params||{},V,a,l);N.body=B,N.request=i;let X=new AbortController,te=new Promise((v,D)=>{let _=setTimeout(()=>{X.abort(),D(new z("Request timeout"));},s);X.signal.addEventListener("abort",()=>clearTimeout(_));}),M=await Promise.race([$.handler(N),te]),E=new Headers(M.headers);I.forEach((v,D)=>{E.has(D)||E.set(D,v);}),E.set("X-Request-ID",l),E.set("X-Content-Type-Options","nosniff"),E.set("X-Frame-Options","DENY"),E.set("X-XSS-Protection","1; mode=block"),E.set("Referrer-Policy","strict-origin-when-cross-origin");let W=Date.now()-p;return F.logRequest(l,L,S,w,M.status,W),a?.info({requestId:l,method:L,path:S,status:M.status,duration:W,ip:w},"Request completed"),new Response(M.body,{status:M.status,headers:E})}catch(b){if(b instanceof T)return a?.warn({error:b.message,requestId:l,ip:w},`App error: ${b.message}`),new Response(JSON.stringify({error:b.message,code:b.code,requestId:l}),{status:b.statusCode,headers:{"Content-Type":"application/json"}});a?.error({error:String(b),requestId:l,ip:w},"Unhandled error");let I=process.env.NODE_ENV==="production"?"Internal Server Error":b.message;return new Response(JSON.stringify({error:I,requestId:l}),{status:500,headers:{"Content-Type":"application/json"}})}finally{y.delete(l);}}let u={method:"GET",path:"/health",handler:i=>i.json({status:"healthy",timestamp:new Date().toISOString(),uptime:process.uptime(),activeRequests:y.size})},g={method:"GET",path:"/readiness",handler:i=>{let d=m.size>0,p=d||m.size===0;return i.json({ready:p,checks:{database:d?"connected":"not configured",activeRequests:y.size},timestamp:new Date().toISOString()},p?200:503)}};if(n.routes&&n.routes.forEach(i=>{h.push(i),(Array.isArray(i.method)?i.method:[i.method]).forEach(p=>{C.register(p,i.path,i.handler,i);});}),n.static){let i=Array.isArray(n.static)?n.static:[n.static];for(let d of i)try{let l=new q(d).handler(),x={method:"GET",path:d.path==="/"?"/*":`${d.path}/*`,handler:l};h.push(x),d.path==="/"?(C.register("GET","/",l,x),C.register("HEAD","/",l,x),C.register("GET","/*",l,x),C.register("HEAD","/*",l,x)):(C.register("GET",`${d.path}/*`,l,x),C.register("HEAD",`${d.path}/*`,l,x));}catch(p){throw a?.error({error:String(p),path:d.path},"Failed to initialize static file server"),p}}h.push(u,g),C.register("GET","/health",u.handler,u),C.register("GET","/readiness",g.handler,g);let f=null,R={app:null,logger:a,db:m,bunServer:null,async start(){if(n.database){let d=Array.isArray(n.database)?n.database:[n.database];for(let p of d){let l=p.name||"default";try{if(typeof p.connection=="string"){let x=new ee__namespace.DB(p.connection);if(p.schema&&typeof p.schema=="object")for(let[,S]of Object.entries(p.schema))S&&typeof S=="object"&&x.defineSchema(S);m.set(l,x),a?.info({name:l,connection:p.connection},"\u2714 Database connected");}else throw new Error(`Database connection must be a string path (got ${typeof p.connection})`)}catch(x){throw a?.error({error:String(x),name:l},"Failed to connect to database"),x}}}f=Bun.serve({port:e,hostname:r,fetch:(d,p)=>H(d,p)}),R.bunServer=f;let i=`http://${r}:${e}`;a?.info({url:i},"Server started");},async stop(){if(a?.info("Stopping server..."),y.size>0){a?.info({count:y.size},"Waiting for active requests...");let i=Date.now()+o;for(;y.size>0&&Date.now()<i;)await new Promise(d=>setTimeout(d,100));y.size>0&&a?.warn({count:y.size},"Force closing with active requests");}if(clearInterval(A),n.onShutdown)try{await n.onShutdown();}catch(i){a?.error({error:String(i)},"Error in shutdown handler");}for(let[i,d]of m.entries())try{d&&typeof d.close=="function"&&d.close(),a?.info({name:i},"Database closed");}catch(p){a?.error({error:String(p),name:i},"Error closing database");}f&&typeof f.stop=="function"&&(f.stop(),a?.info("Bun server stopped")),a?.info("Server stopped successfully");},addRoute(i){h.push(i),(Array.isArray(i.method)?i.method:[i.method]).forEach(p=>{C.register(p,i.path,i.handler,i);}),a?.info({method:i.method,path:i.path},"Route added");},addRoutes(i){i.forEach(d=>this.addRoute(d));},getRoutes(){return h}};return R}async function de(n,e,r){let t=n.headers.get("content-type")||"";try{if(t.includes("application/json")){let s=await n.text();if(s.length>r)throw new k("Payload too large");if(!s.trim())return {};try{return JSON.parse(s)}catch(o){throw e?.warn({error:String(o),bodyPreview:s.substring(0,100)},"Invalid JSON in request body"),new k("Invalid JSON in request body")}}if(t.includes("application/x-www-form-urlencoded")){let s=await n.text();if(s.length>r)throw new k("Payload too large");return Object.fromEntries(new URLSearchParams(s))}if(t.includes("multipart/form-data"))return await n.formData()}catch(s){throw s instanceof k?s:(e?.error({error:String(s)},"Error parsing request body"),new k("Failed to parse request body"))}return {}}function le(n){let e=new Map;if(!n)return e;let r=n.split(";");for(let t of r){let[s,...o]=t.trim().split("=");if(s){let c=o.join("=");e.set(s,c?decodeURIComponent(c):"");}}return e}function Y(n,e,r,t,s,o){let c=new URL(e.url),a=Object.fromEntries(c.searchParams),m=e.headers,h=200,y=new Map,A=le(m.get("cookie")||""),H={ip:n,request:e,params:r,query:a,headers:m,db:t,logger:s,requestId:o,get statusCode(){return h},set statusCode(u){h=u;},body:null,json(u,g){return new Response(JSON.stringify(u),{status:g??h,headers:{"Content-Type":"application/json",...this._setCookieHeaders()}})},text(u,g){return new Response(u,{status:g??h,headers:{"Content-Type":"text/plain",...this._setCookieHeaders()}})},html(u,g){return new Response(u,{status:g??h,headers:{"Content-Type":"text/html; charset=utf-8",...this._setCookieHeaders()}})},redirect(u,g=302){return new Response(null,{status:g,headers:{Location:u,...this._setCookieHeaders()}})},file(u,g="application/octet-stream"){let f=Bun.file(u);return new Response(f,{headers:{"Content-Type":g,...this._setCookieHeaders()}})},setCookie(u,g,f={}){let R=`${u}=${encodeURIComponent(g)}`;return f.maxAge!==void 0&&(R+=`; Max-Age=${f.maxAge}`),f.expires&&(R+=`; Expires=${f.expires.toUTCString()}`),f.path&&(R+=`; Path=${f.path}`),f.domain&&(R+=`; Domain=${f.domain}`),f.secure&&(R+="; Secure"),f.httpOnly&&(R+="; HttpOnly"),f.sameSite&&(R+=`; SameSite=${f.sameSite}`),y.set(u,R),H},getCookie(u){return A.get(u)},deleteCookie(u,g={}){return H.setCookie(u,"",{...g,maxAge:0,path:g.path||"/"})},setHeader(u,g){return m.set(u,g),H},getHeader(u){return m.get(u)||void 0},status(u){return h=u,H},_setCookieHeaders(){let u={};return y.size>0&&(u["Set-Cookie"]=Array.from(y.values())),u}};return H}function pe(n,e){let r=n.headers.get("x-forwarded-for");if(r)return r.split(",").map(o=>o.trim())[0]||"unknown";let t=n.headers.get("x-real-ip");if(t)return t;if(e)try{let o=e.requestIP?.(n);if(o?.address)return o.address}catch{}return "unknown"}function ge(n,e){let r=new Headers;if(!e.security||typeof e.security!="object"||!e.security.cors)return r;let t=typeof e.security.cors=="object"?e.security.cors:{},s=n.headers.get("Origin");if(s){typeof t.origin=="function"?t.origin(s)&&r.set("Access-Control-Allow-Origin",s):Array.isArray(t.origin)?t.origin.includes(s)&&r.set("Access-Control-Allow-Origin",s):typeof t.origin=="string"?r.set("Access-Control-Allow-Origin",t.origin):r.set("Access-Control-Allow-Origin",s);let o=t.methods||["GET","POST","PUT","DELETE","PATCH","OPTIONS"];r.set("Access-Control-Allow-Methods",o.join(", "));let c=t.allowedHeaders||["Content-Type","Authorization","X-Requested-With"];r.set("Access-Control-Allow-Headers",c.join(", ")),t.credentials&&r.set("Access-Control-Allow-Credentials","true"),t.maxAge&&r.set("Access-Control-Max-Age",t.maxAge.toString());}return r}var Se=ue;
Object.defineProperty(exports,"DB",{enumerable:true,get:function(){return ee.DB}});Object.defineProperty(exports,"blob",{enumerable:true,get:function(){return ee.blob}});Object.defineProperty(exports,"column",{enumerable:true,get:function(){return ee.column}});Object.defineProperty(exports,"defaultValue",{enumerable:true,get:function(){return ee.defaultValue}});Object.defineProperty(exports,"integer",{enumerable:true,get:function(){return ee.integer}});Object.defineProperty(exports,"notNull",{enumerable:true,get:function(){return ee.notNull}});Object.defineProperty(exports,"numeric",{enumerable:true,get:function(){return ee.numeric}});Object.defineProperty(exports,"primaryKey",{enumerable:true,get:function(){return ee.primaryKey}});Object.defineProperty(exports,"real",{enumerable:true,get:function(){return ee.real}});Object.defineProperty(exports,"references",{enumerable:true,get:function(){return ee.references}});Object.defineProperty(exports,"table",{enumerable:true,get:function(){return ee.table}});Object.defineProperty(exports,"text",{enumerable:true,get:function(){return ee.text}});Object.defineProperty(exports,"unique",{enumerable:true,get:function(){return ee.unique}});Object.defineProperty(exports,"Logger",{enumerable:true,get:function(){return slog.Logger}});exports.AppError=T;exports.DatabaseError=K;exports.RateLimitError=Z;exports.Router=O;exports.SecurityManager=j;exports.StaticFileServer=q;exports.TimeoutError=z;exports.ValidationError=k;exports.createStatic=ie;exports.default=Se;exports.server=ue;//# sourceMappingURL=main.cjs.map
//# sourceMappingURL=main.cjs.map