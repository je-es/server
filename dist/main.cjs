'use strict';Object.defineProperty(exports,'__esModule',{value:true});var bunSql=require('drizzle-orm/bun-sql'),W=require('crypto'),sqliteCore=require('drizzle-orm/sqlite-core'),drizzleOrm=require('drizzle-orm');function _interopDefault(e){return e&&e.__esModule?e:{default:e}}var W__default=/*#__PURE__*/_interopDefault(W);var D=class{constructor(){this.routes=new Map;this.regexRoutes=[];}match(e,t){let r=`${e}:${t}`;if(this.routes.has(r))return {handler:this.routes.get(r),params:{}};for(let n of this.regexRoutes)if(n.method===e){let c=t.match(n.pattern);if(c?.groups)return {handler:n.handler,params:c.groups}}return null}getAll(){let e=Array.from(this.routes.entries()).map(([r,n])=>{let c=r.indexOf(":"),d=r.substring(0,c),a=r.substring(c+1);return {method:d,path:a,handler:n}}),t=this.regexRoutes.map(r=>{let n=r.key.indexOf(":");return {method:r.method,path:r.key.substring(n+1),handler:r.handler}});return [...e,...t]}clear(){this.routes.clear(),this.regexRoutes=[];}remove(e,t){let r=`${e}:${t}`;if(this.routes.has(r))return this.routes.delete(r),true;let n=this.regexRoutes.findIndex(c=>c.key===r);return n>=0?(this.regexRoutes.splice(n,1),true):false}register(e,t,r,n={}){let c=`${e}:${t}`;if(t.includes(":")){let d=this.pathToRegex(t),a=this.regexRoutes.findIndex(b=>b.key===c),l={pattern:d,method:e,handler:r,key:c};a>=0?this.regexRoutes[a]=l:this.regexRoutes.push(l);}else this.routes.set(c,r);}pathToRegex(e){let r=e.replace(/[.+?^${}()|[\]\\]/g,"\\$&").replace(/:(\w+)/g,"(?<$1>[^/]+)");return new RegExp(`^${r}$`)}};var I=class{constructor(){this.rateLimitStore=new Map;this.csrfTokens=new Map;this.requestLog=new Map;this.MAX_REQUEST_LOG_SIZE=1e3;}checkRateLimit(e,t,r){let n=Date.now(),c=this.rateLimitStore.get(e);return c?n<c.reset?c.count>=t?false:(c.count++,true):(this.rateLimitStore.set(e,{count:1,reset:n+r}),true):(this.rateLimitStore.set(e,{count:1,reset:n+r}),true)}cleanupRateLimit(){let e=Date.now();for(let[t,r]of this.rateLimitStore.entries())e>r.reset&&this.rateLimitStore.delete(t);}generateCsrfToken(e,t=36e5){let r=W__default.default.randomBytes(32).toString("hex");return this.csrfTokens.set(r,{sessionId:e,expires:Date.now()+t}),r}validateCsrfToken(e,t){let r=this.csrfTokens.get(e);return r?Date.now()>r.expires?(this.csrfTokens.delete(e),false):r.sessionId===t?(this.csrfTokens.delete(e),true):false:false}cleanupCsrfTokens(){let e=Date.now();for(let[t,r]of this.csrfTokens.entries())e>r.expires&&this.csrfTokens.delete(t);}sanitizeHtml(e){return e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;"):""}sanitizeSql(e){return e?e.replace(/\\/g,"\\\\").replace(/;/g,"").replace(/'/g,"''").replace(/"/g,'\\"').replace(/\x00/g,""):""}logRequest(e,t,r,n,c,d){if(this.requestLog.set(e,{timestamp:new Date().toISOString(),method:t,path:r,ip:n,status:c,duration:d}),this.requestLog.size>this.MAX_REQUEST_LOG_SIZE){let{value:a}=this.requestLog.keys().next()||{value:null};a&&this.requestLog.delete(a);}}getRequestLog(e){return this.requestLog.get(e)}getAllRequestLogs(){return Array.from(this.requestLog.values())}clearAll(){this.rateLimitStore.clear(),this.csrfTokens.clear(),this.requestLog.clear();}getStats(){return {rateLimitEntries:this.rateLimitStore.size,csrfTokens:this.csrfTokens.size,requestLogs:this.requestLog.size}}};var P=class{constructor(e="info",t=false){this.level=1;this.pretty=false;this.levels={debug:0,info:1,warn:2,error:3,fatal:4};this.level=this.levels[e]??1,this.pretty=t;}debug(e,t){this.log("debug",this.levels.debug,e,t);}info(e,t){this.log("info",this.levels.info,e,t);}warn(e,t){this.log("warn",this.levels.warn,e,t);}error(e,t){this.log("error",this.levels.error,e,t);}fatal(e,t){this.log("fatal",this.levels.fatal,e,t),process.env.NODE_ENV;}log(e,t,r,n){if(t<this.level)return;let c=new Date().toISOString(),d=r??{},a={timestamp:c,level:e.toUpperCase(),message:n||"No message",...d},l=this.pretty?`[${c}] ${e.toUpperCase()} ${n||"No message"}
${JSON.stringify(d,null,2)}`:JSON.stringify(a);e==="error"||e==="fatal"?console.error(l):e==="warn"?console.warn(l):console.log(l);}};var v=class extends Error{constructor(t,r=500,n){super(t);this.message=t;this.statusCode=r;this.code=n;this.name="AppError";}},A=class extends v{constructor(t,r){super(t,400,"VALIDATION_ERROR");this.issues=r;this.name="ValidationError";}},Q=class extends v{constructor(e){super(e,500,"DATABASE_ERROR"),this.name="DatabaseError";}},$=class extends v{constructor(e="Request timeout"){super(e,408,"TIMEOUT_ERROR"),this.name="TimeoutError";}},X=class extends v{constructor(e="Too many requests"){super(e,429,"RATE_LIMIT_ERROR"),this.name="RateLimitError";}};var H=new I,O=new D;function Y(s={}){let e=s.port||3e3,t=s.hostname||"localhost",r=s.maxRequestSize||10*1024*1024,n=s.requestTimeout||3e4,c=s.gracefulShutdownTimeout||1e4,d=typeof s.logging=="object"?s.logging:{},a=s.logging?new P(d.level||"info",d.pretty):null,l=new Map,b=[],x=new Set,T=setInterval(()=>{H.cleanupRateLimit(),H.cleanupCsrfTokens();},120*1e3);async function u(o){let h=Date.now(),i=crypto.randomUUID(),m=new URL(o.url).pathname,E=o.method.toUpperCase(),R=re(o);x.add(i);try{let y=o.headers.get("content-length");if(y&&parseInt(y)>r)return a?.warn({requestId:i,size:y,ip:R},"Request too large"),new Response(JSON.stringify({error:"Payload too large"}),{status:413,headers:{"Content-Type":"application/json"}});let q=ne(o,s);if(E==="OPTIONS")return new Response(null,{status:204,headers:q});if(s.security&&typeof s.security=="object"&&s.security.rateLimit){let w=typeof s.security.rateLimit=="object"?s.security.rateLimit:{},L=w.max||100,z=w.windowMs||6e4,V=w.keyGenerator?w.keyGenerator({request:o,ip:R}):R;if(!H.checkRateLimit(V,L,z))return a?.warn({requestId:i,ip:R,key:V},"Rate limit exceeded"),new Response(JSON.stringify({error:w.message||"Too many requests"}),{status:429,headers:{"Content-Type":"application/json"}})}let U=null;["POST","PUT","PATCH"].includes(E)&&(U=await ee(o,a,r));let B=l.get("default"),N=O.match(E,m);if(!N){let w=F(o,{},B,a,i);return a?.warn({requestId:i,method:E,path:m,ip:R},"Route not found"),w.json({error:"Not Found",path:m},404)}let M=F(o,N.params||{},B,a,i);M.body=U,M.request=o;let G=new AbortController,K=new Promise((w,L)=>{let z=setTimeout(()=>{G.abort(),L(new $("Request timeout"));},n);G.signal.addEventListener("abort",()=>clearTimeout(z));}),k=await Promise.race([N.handler(M),K]),S=new Headers(k.headers);q.forEach((w,L)=>{S.has(L)||S.set(L,w);}),S.set("X-Request-ID",i),S.set("X-Content-Type-Options","nosniff"),S.set("X-Frame-Options","DENY"),S.set("X-XSS-Protection","1; mode=block"),S.set("Referrer-Policy","strict-origin-when-cross-origin");let J=Date.now()-h;return H.logRequest(i,E,m,R,k.status,J),a?.info({requestId:i,method:E,path:m,status:k.status,duration:J,ip:R},"Request completed"),new Response(k.body,{status:k.status,headers:S})}catch(y){if(y instanceof v)return a?.warn({error:y.message,requestId:i,ip:R},`App error: ${y.message}`),new Response(JSON.stringify({error:y.message,code:y.code,requestId:i}),{status:y.statusCode,headers:{"Content-Type":"application/json"}});a?.error({error:String(y),requestId:i,ip:R},"Unhandled error");let q=process.env.NODE_ENV==="production"?"Internal Server Error":y.message;return new Response(JSON.stringify({error:q,requestId:i}),{status:500,headers:{"Content-Type":"application/json"}})}finally{x.delete(i);}}let p={method:"GET",path:"/health",handler:o=>o.json({status:"healthy",timestamp:new Date().toISOString(),uptime:process.uptime(),activeRequests:x.size})},g={method:"GET",path:"/readiness",handler:o=>{let h=l.size>0,i=h||l.size===0;return o.json({ready:i,checks:{database:h?"connected":"not configured",activeRequests:x.size},timestamp:new Date().toISOString()},i?200:503)}};s.routes&&s.routes.forEach(o=>{b.push(o),(Array.isArray(o.method)?o.method:[o.method]).forEach(i=>{O.register(i,o.path,o.handler,o);});}),b.push(p,g),O.register("GET","/health",p.handler,p),O.register("GET","/readiness",g.handler,g);let f=null,_={app:null,logger:a,db:l,bunServer:null,async start(){if(s.database){let h=Array.isArray(s.database)?s.database:[s.database];for(let i of h){let C=i.name||"default";try{if(i.type||(i.type="bun-sql"),i.type==="bun-sql")if(typeof i.connection=="string"){let m=bunSql.drizzle(i.connection,{schema:i.schema});l.set(C,m),a?.info({name:C,connection:"string"},"\u2705 Bun SQL connected");}else if(typeof i.connection=="function"){let m=bunSql.drizzle({client:i.connection,schema:i.schema});l.set(C,m),a?.info({name:C,connection:"function"},"\u2705 Bun SQL connected");}else if(i.connection!==null&&i.connection!==void 0&&typeof i.connection=="object"){let m=bunSql.drizzle({client:i.connection,schema:i.schema});l.set(C,m),a?.info({name:C,connection:"object"},"\u2705 Bun SQL connected");}else {let m=typeof i.connection;throw new Error(`Bun SQL connection must be a connection string, SQL function, or SQL instance (got ${m})`)}else throw new Error(`Unsupported database type: ${i.type}`)}catch(m){throw a?.error({error:String(m),name:C,type:i.type},"Failed to connect to database"),m}}}f=Bun.serve({port:e,hostname:t,fetch:u}),_.bunServer=f;let o=`http://${t}:${e}`;console.log(`\u2192 URL:          ${o}
\u2192 Environment:  ${process.env.NODE_ENV||"development"}
\u2192 Routes:       ${b.length.toString()}
\u2192 Database:     ${l.size>0?"\u2705 Connected":"\u274C None"}
\u2192 Security:     ${s.security?"\u2705 ENABLED":"\u274C Disabled"}

\u{1F50D} Health:    ${o}/health
\u{1F50D} Ready:     ${o}/readiness
`),a?.info({url:o},"Server started");},async stop(){if(a?.info("Stopping server..."),x.size>0){a?.info({count:x.size},"Waiting for active requests...");let o=Date.now()+c;for(;x.size>0&&Date.now()<o;)await new Promise(h=>setTimeout(h,100));x.size>0&&a?.warn({count:x.size},"Force closing with active requests");}if(clearInterval(T),s.onShutdown)try{await s.onShutdown();}catch(o){a?.error({error:String(o)},"Error in shutdown handler");}for(let[o,h]of l.entries())try{h?.$client?.close&&h.$client.close(),a?.info({name:o},"Database closed");}catch(i){a?.error({error:String(i),name:o},"Error closing database");}f&&(f.stop(),a?.info("Bun server stopped")),a?.info("Server stopped successfully");},addRoute(o){b.push(o),(Array.isArray(o.method)?o.method:[o.method]).forEach(i=>{O.register(i,o.path,o.handler,o);}),a?.info({method:o.method,path:o.path},"Route added");},getRoutes(){return b}};return _}async function ee(s,e,t){let r=s.headers.get("content-type")||"";try{if(r.includes("application/json")){let n=await s.text();if(n.length>t)throw new A("Payload too large");if(!n.trim())return {};try{return JSON.parse(n)}catch(c){throw e?.warn({error:String(c),bodyPreview:n.substring(0,100)},"Invalid JSON in request body"),new A("Invalid JSON in request body")}}if(r.includes("application/x-www-form-urlencoded")){let n=await s.text();if(n.length>t)throw new A("Payload too large");return Object.fromEntries(new URLSearchParams(n))}if(r.includes("multipart/form-data"))return await s.formData()}catch(n){throw n instanceof A?n:(e?.error({error:String(n)},"Error parsing request body"),new A("Failed to parse request body"))}return {}}function te(s){let e=new Map;if(!s)return e;let t=s.split(";");for(let r of t){let[n,...c]=r.trim().split("=");if(n){let d=c.join("=");e.set(n,d?decodeURIComponent(d):"");}}return e}function F(s,e,t,r,n){let c=new URL(s.url),d=Object.fromEntries(c.searchParams),a=s.headers,l=200,b=new Map,x=te(a.get("cookie")||""),T={request:s,params:e,query:d,headers:a,db:t,logger:r,requestId:n,get statusCode(){return l},set statusCode(u){l=u;},body:null,json(u,p){return new Response(JSON.stringify(u),{status:p??l,headers:{"Content-Type":"application/json",...this._setCookieHeaders()}})},text(u,p){return new Response(u,{status:p??l,headers:{"Content-Type":"text/plain",...this._setCookieHeaders()}})},html(u,p){return new Response(u,{status:p??l,headers:{"Content-Type":"text/html; charset=utf-8",...this._setCookieHeaders()}})},redirect(u,p=302){return new Response(null,{status:p,headers:{Location:u,...this._setCookieHeaders()}})},file(u,p="application/octet-stream"){let g=Bun.file(u);return new Response(g,{headers:{"Content-Type":p,...this._setCookieHeaders()}})},setCookie(u,p,g={}){let f=`${u}=${encodeURIComponent(p)}`;return g.maxAge!==void 0&&(f+=`; Max-Age=${g.maxAge}`),g.expires&&(f+=`; Expires=${g.expires.toUTCString()}`),g.path&&(f+=`; Path=${g.path}`),g.domain&&(f+=`; Domain=${g.domain}`),g.secure&&(f+="; Secure"),g.httpOnly&&(f+="; HttpOnly"),g.sameSite&&(f+=`; SameSite=${g.sameSite}`),b.set(u,f),T},getCookie(u){return x.get(u)},deleteCookie(u,p={}){return T.setCookie(u,"",{...p,maxAge:0,path:p.path||"/"})},setHeader(u,p){return a.set(u,p),T},getHeader(u){return a.get(u)||void 0},status(u){return l=u,T},_setCookieHeaders(){let u={};return b.size>0&&(u["Set-Cookie"]=Array.from(b.values())),u}};return T}function re(s){let e=s.headers.get("x-forwarded-for");if(e)return e.split(",").map(n=>n.trim())[0]||"unknown";let t=s.headers.get("x-real-ip");return t||"unknown"}function ne(s,e){let t=new Headers;if(!e.security||typeof e.security!="object"||!e.security.cors)return t;let r=typeof e.security.cors=="object"?e.security.cors:{},n=s.headers.get("Origin");if(n){typeof r.origin=="function"?r.origin(n)&&t.set("Access-Control-Allow-Origin",n):Array.isArray(r.origin)?r.origin.includes(n)&&t.set("Access-Control-Allow-Origin",n):typeof r.origin=="string"?t.set("Access-Control-Allow-Origin",r.origin):t.set("Access-Control-Allow-Origin",n);let c=r.methods||["GET","POST","PUT","DELETE","PATCH","OPTIONS"];t.set("Access-Control-Allow-Methods",c.join(", "));let d=r.allowedHeaders||["Content-Type","Authorization","X-Requested-With"];t.set("Access-Control-Allow-Headers",d.join(", ")),r.credentials&&t.set("Access-Control-Allow-Credentials","true"),r.maxAge&&t.set("Access-Control-Max-Age",r.maxAge.toString());}return t}var de=Y;Object.defineProperty(exports,"blob",{enumerable:true,get:function(){return sqliteCore.blob}});Object.defineProperty(exports,"check",{enumerable:true,get:function(){return sqliteCore.check}});Object.defineProperty(exports,"foreignKey",{enumerable:true,get:function(){return sqliteCore.foreignKey}});Object.defineProperty(exports,"index",{enumerable:true,get:function(){return sqliteCore.index}});Object.defineProperty(exports,"integer",{enumerable:true,get:function(){return sqliteCore.integer}});Object.defineProperty(exports,"numeric",{enumerable:true,get:function(){return sqliteCore.numeric}});Object.defineProperty(exports,"primaryKey",{enumerable:true,get:function(){return sqliteCore.primaryKey}});Object.defineProperty(exports,"real",{enumerable:true,get:function(){return sqliteCore.real}});Object.defineProperty(exports,"sqliteTable",{enumerable:true,get:function(){return sqliteCore.sqliteTable}});Object.defineProperty(exports,"text",{enumerable:true,get:function(){return sqliteCore.text}});Object.defineProperty(exports,"uniqueIndex",{enumerable:true,get:function(){return sqliteCore.uniqueIndex}});Object.defineProperty(exports,"Many",{enumerable:true,get:function(){return drizzleOrm.Many}});Object.defineProperty(exports,"One",{enumerable:true,get:function(){return drizzleOrm.One}});Object.defineProperty(exports,"and",{enumerable:true,get:function(){return drizzleOrm.and}});Object.defineProperty(exports,"asc",{enumerable:true,get:function(){return drizzleOrm.asc}});Object.defineProperty(exports,"between",{enumerable:true,get:function(){return drizzleOrm.between}});Object.defineProperty(exports,"desc",{enumerable:true,get:function(){return drizzleOrm.desc}});Object.defineProperty(exports,"eq",{enumerable:true,get:function(){return drizzleOrm.eq}});Object.defineProperty(exports,"exists",{enumerable:true,get:function(){return drizzleOrm.exists}});Object.defineProperty(exports,"gt",{enumerable:true,get:function(){return drizzleOrm.gt}});Object.defineProperty(exports,"gte",{enumerable:true,get:function(){return drizzleOrm.gte}});Object.defineProperty(exports,"ilike",{enumerable:true,get:function(){return drizzleOrm.ilike}});Object.defineProperty(exports,"inArray",{enumerable:true,get:function(){return drizzleOrm.inArray}});Object.defineProperty(exports,"isNotNull",{enumerable:true,get:function(){return drizzleOrm.isNotNull}});Object.defineProperty(exports,"isNull",{enumerable:true,get:function(){return drizzleOrm.isNull}});Object.defineProperty(exports,"like",{enumerable:true,get:function(){return drizzleOrm.like}});Object.defineProperty(exports,"lt",{enumerable:true,get:function(){return drizzleOrm.lt}});Object.defineProperty(exports,"lte",{enumerable:true,get:function(){return drizzleOrm.lte}});Object.defineProperty(exports,"ne",{enumerable:true,get:function(){return drizzleOrm.ne}});Object.defineProperty(exports,"not",{enumerable:true,get:function(){return drizzleOrm.not}});Object.defineProperty(exports,"notBetween",{enumerable:true,get:function(){return drizzleOrm.notBetween}});Object.defineProperty(exports,"notExists",{enumerable:true,get:function(){return drizzleOrm.notExists}});Object.defineProperty(exports,"notInArray",{enumerable:true,get:function(){return drizzleOrm.notInArray}});Object.defineProperty(exports,"or",{enumerable:true,get:function(){return drizzleOrm.or}});Object.defineProperty(exports,"relations",{enumerable:true,get:function(){return drizzleOrm.relations}});Object.defineProperty(exports,"sql",{enumerable:true,get:function(){return drizzleOrm.sql}});exports.AppError=v;exports.DatabaseError=Q;exports.Logger=P;exports.RateLimitError=X;exports.Router=D;exports.SecurityManager=I;exports.TimeoutError=$;exports.ValidationError=A;exports.default=de;exports.server=Y;//# sourceMappingURL=main.cjs.map
//# sourceMappingURL=main.cjs.map