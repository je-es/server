import {drizzle}from'drizzle-orm/bun-sqlite';import {Database}from'bun:sqlite';import W from'crypto';var D=class{constructor(){this.routes=new Map;this.regexRoutes=[];}match(e,t){let r=`${e}:${t}`;if(this.routes.has(r))return {handler:this.routes.get(r),params:{}};for(let n of this.regexRoutes)if(n.method===e){let c=t.match(n.pattern);if(c?.groups)return {handler:n.handler,params:c.groups}}return null}getAll(){let e=Array.from(this.routes.entries()).map(([r,n])=>{let c=r.indexOf(":"),d=r.substring(0,c),i=r.substring(c+1);return {method:d,path:i,handler:n}}),t=this.regexRoutes.map(r=>{let n=r.key.indexOf(":");return {method:r.method,path:r.key.substring(n+1),handler:r.handler}});return [...e,...t]}clear(){this.routes.clear(),this.regexRoutes=[];}remove(e,t){let r=`${e}:${t}`;if(this.routes.has(r))return this.routes.delete(r),true;let n=this.regexRoutes.findIndex(c=>c.key===r);return n>=0?(this.regexRoutes.splice(n,1),true):false}register(e,t,r,n={}){let c=`${e}:${t}`;if(t.includes(":")){let d=this.pathToRegex(t),i=this.regexRoutes.findIndex(y=>y.key===c),l={pattern:d,method:e,handler:r,key:c};i>=0?this.regexRoutes[i]=l:this.regexRoutes.push(l);}else this.routes.set(c,r);}pathToRegex(e){let r=e.replace(/[.+?^${}()|[\]\\]/g,"\\$&").replace(/:(\w+)/g,"(?<$1>[^/]+)");return new RegExp(`^${r}$`)}};var q=class{constructor(){this.rateLimitStore=new Map;this.csrfTokens=new Map;this.requestLog=new Map;this.MAX_REQUEST_LOG_SIZE=1e3;}checkRateLimit(e,t,r){let n=Date.now(),c=this.rateLimitStore.get(e);return c?n<c.reset?c.count>=t?false:(c.count++,true):(this.rateLimitStore.set(e,{count:1,reset:n+r}),true):(this.rateLimitStore.set(e,{count:1,reset:n+r}),true)}cleanupRateLimit(){let e=Date.now();for(let[t,r]of this.rateLimitStore.entries())e>r.reset&&this.rateLimitStore.delete(t);}generateCsrfToken(e,t=36e5){let r=W.randomBytes(32).toString("hex");return this.csrfTokens.set(r,{sessionId:e,expires:Date.now()+t}),r}validateCsrfToken(e,t){let r=this.csrfTokens.get(e);return r?Date.now()>r.expires?(this.csrfTokens.delete(e),false):r.sessionId===t?(this.csrfTokens.delete(e),true):false:false}cleanupCsrfTokens(){let e=Date.now();for(let[t,r]of this.csrfTokens.entries())e>r.expires&&this.csrfTokens.delete(t);}sanitizeHtml(e){return e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;"):""}sanitizeSql(e){return e?e.replace(/\\/g,"\\\\").replace(/;/g,"").replace(/'/g,"''").replace(/"/g,'\\"').replace(/\x00/g,""):""}logRequest(e,t,r,n,c,d){if(this.requestLog.set(e,{timestamp:new Date().toISOString(),method:t,path:r,ip:n,status:c,duration:d}),this.requestLog.size>this.MAX_REQUEST_LOG_SIZE){let{value:i}=this.requestLog.keys().next()||{value:null};i&&this.requestLog.delete(i);}}getRequestLog(e){return this.requestLog.get(e)}getAllRequestLogs(){return Array.from(this.requestLog.values())}clearAll(){this.rateLimitStore.clear(),this.csrfTokens.clear(),this.requestLog.clear();}getStats(){return {rateLimitEntries:this.rateLimitStore.size,csrfTokens:this.csrfTokens.size,requestLogs:this.requestLog.size}}};var I=class{constructor(e="info",t=false){this.level=1;this.pretty=false;this.levels={debug:0,info:1,warn:2,error:3,fatal:4};this.level=this.levels[e]??1,this.pretty=t;}debug(e,t){this.log("debug",this.levels.debug,e,t);}info(e,t){this.log("info",this.levels.info,e,t);}warn(e,t){this.log("warn",this.levels.warn,e,t);}error(e,t){this.log("error",this.levels.error,e,t);}fatal(e,t){this.log("fatal",this.levels.fatal,e,t),process.env.NODE_ENV;}log(e,t,r,n){if(t<this.level)return;let c=new Date().toISOString(),d=r??{},i={timestamp:c,level:e.toUpperCase(),message:n||"No message",...d},l=this.pretty?`[${c}] ${e.toUpperCase()} ${n||"No message"}
${JSON.stringify(d,null,2)}`:JSON.stringify(i);e==="error"||e==="fatal"?console.error(l):e==="warn"?console.warn(l):console.log(l);}};var C=class extends Error{constructor(t,r=500,n){super(t);this.message=t;this.statusCode=r;this.code=n;this.name="AppError";}},S=class extends C{constructor(t,r){super(t,400,"VALIDATION_ERROR");this.issues=r;this.name="ValidationError";}},X=class extends C{constructor(e){super(e,500,"DATABASE_ERROR"),this.name="DatabaseError";}},P=class extends C{constructor(e="Request timeout"){super(e,408,"TIMEOUT_ERROR"),this.name="TimeoutError";}},B=class extends C{constructor(e="Too many requests"){super(e,429,"RATE_LIMIT_ERROR"),this.name="RateLimitError";}};var H=new q,k=new D;function ee(s={}){let e=s.port||3e3,t=s.hostname||"localhost",r=s.maxRequestSize||10*1024*1024,n=s.requestTimeout||3e4,c=s.gracefulShutdownTimeout||1e4,d=typeof s.logging=="object"?s.logging:{},i=s.logging?new I(d.level||"info",d.pretty):null,l=new Map,y=[],b=new Set,v=setInterval(()=>{H.cleanupRateLimit(),H.cleanupCsrfTokens();},120*1e3);async function u(o){let f=Date.now(),a=crypto.randomUUID(),A=new URL(o.url).pathname,T=o.method.toUpperCase(),R=ne(o);b.add(a);try{let h=o.headers.get("content-length");if(h&&parseInt(h)>r)return i?.warn({requestId:a,size:h,ip:R},"Request too large"),new Response(JSON.stringify({error:"Payload too large"}),{status:413,headers:{"Content-Type":"application/json"}});let O=se(o,s);if(T==="OPTIONS")return new Response(null,{status:204,headers:O});if(s.security&&typeof s.security=="object"&&s.security.rateLimit){let x=typeof s.security.rateLimit=="object"?s.security.rateLimit:{},E=x.max||100,N=x.windowMs||6e4,V=x.keyGenerator?x.keyGenerator({request:o,ip:R}):R;if(!H.checkRateLimit(V,E,N))return i?.warn({requestId:a,ip:R,key:V},"Rate limit exceeded"),new Response(JSON.stringify({error:x.message||"Too many requests"}),{status:429,headers:{"Content-Type":"application/json"}})}let _=null;["POST","PUT","PATCH"].includes(T)&&(_=await te(o,i,r));let U=l.get("default"),$=k.match(T,A);if(!$){let x=Q(o,{},U,i,a);return i?.warn({requestId:a,method:T,path:A,ip:R},"Route not found"),x.json({error:"Not Found",path:A},404)}let M=Q(o,$.params||{},U,i,a);M.body=_,M.request=o;let G=new AbortController,K=new Promise((x,E)=>{let N=setTimeout(()=>{G.abort(),E(new P("Request timeout"));},n);G.signal.addEventListener("abort",()=>clearTimeout(N));}),L=await Promise.race([$.handler(M),K]),w=new Headers(L.headers);O.forEach((x,E)=>{w.has(E)||w.set(E,x);}),w.set("X-Request-ID",a),w.set("X-Content-Type-Options","nosniff"),w.set("X-Frame-Options","DENY"),w.set("X-XSS-Protection","1; mode=block"),w.set("Referrer-Policy","strict-origin-when-cross-origin");let J=Date.now()-f;return H.logRequest(a,T,A,R,L.status,J),i?.info({requestId:a,method:T,path:A,status:L.status,duration:J,ip:R},"Request completed"),new Response(L.body,{status:L.status,headers:w})}catch(h){if(h instanceof C)return i?.warn({error:h.message,requestId:a,ip:R},`App error: ${h.message}`),new Response(JSON.stringify({error:h.message,code:h.code,requestId:a}),{status:h.statusCode,headers:{"Content-Type":"application/json"}});i?.error({error:String(h),requestId:a,ip:R},"Unhandled error");let O=process.env.NODE_ENV==="production"?"Internal Server Error":h.message;return new Response(JSON.stringify({error:O,requestId:a}),{status:500,headers:{"Content-Type":"application/json"}})}finally{b.delete(a);}}let p={method:"GET",path:"/health",handler:o=>o.json({status:"healthy",timestamp:new Date().toISOString(),uptime:process.uptime(),activeRequests:b.size})},g={method:"GET",path:"/readiness",handler:o=>{let f=l.size>0,a=f||l.size===0;return o.json({ready:a,checks:{database:f?"connected":"not configured",activeRequests:b.size},timestamp:new Date().toISOString()},a?200:503)}};s.routes&&s.routes.forEach(o=>{y.push(o),(Array.isArray(o.method)?o.method:[o.method]).forEach(a=>{k.register(a,o.path,o.handler,o);});}),y.push(p,g),k.register("GET","/health",p.handler,p),k.register("GET","/readiness",g.handler,g);let m=null,z={app:null,logger:i,db:l,bunServer:null,async start(){if(s.database){let f=Array.isArray(s.database)?s.database:[s.database];for(let a of f)if(a.type==="sqlite"){if(typeof a.connection!="string"&&!(a.connection instanceof Database))throw new Error("SQLite connection must be a string path or Database instance");let j=typeof a.connection=="string"?new Database(a.connection):a.connection,A=drizzle(j,{schema:a.schema});l.set(a.name||"default",A),i?.info({name:a.name||"default"},"\u2705 SQLite connected");}}m=Bun.serve({port:e,hostname:t,fetch:u}),z.bunServer=m;let o=`http://${t}:${e}`;console.log(`\u2192 URL:          ${o}
\u2192 Environment:  ${process.env.NODE_ENV||"development"}
\u2192 Routes:       ${y.length.toString()}
\u2192 Database:     ${l.size>0?"\u2705 Connected":"\u274C None"}
\u2192 Security:     ${s.security?"\u2705 ENABLED":"\u274C Disabled"}

\u{1F50D} Health:    ${o}/health
\u{1F50D} Ready:     ${o}/readiness
`),i?.info({url:o},"Server started");},async stop(){if(i?.info("Stopping server..."),b.size>0){i?.info({count:b.size},"Waiting for active requests...");let o=Date.now()+c;for(;b.size>0&&Date.now()<o;)await new Promise(f=>setTimeout(f,100));b.size>0&&i?.warn({count:b.size},"Force closing with active requests");}if(clearInterval(v),s.onShutdown)try{await s.onShutdown();}catch(o){i?.error({error:String(o)},"Error in shutdown handler");}for(let[o,f]of l.entries())try{f?.close&&await f.close(),i?.info({name:o},"Database closed");}catch(a){i?.error({error:String(a),name:o},"Error closing database");}m&&(m.stop(),i?.info("Bun server stopped")),i?.info("Server stopped successfully");},addRoute(o){y.push(o),(Array.isArray(o.method)?o.method:[o.method]).forEach(a=>{k.register(a,o.path,o.handler,o);}),i?.info({method:o.method,path:o.path},"Route added");},getRoutes(){return y}};return z}async function te(s,e,t){let r=s.headers.get("content-type")||"";try{if(r.includes("application/json")){let n=await s.text();if(n.length>t)throw new S("Payload too large");if(!n.trim())return {};try{return JSON.parse(n)}catch(c){throw e?.warn({error:String(c),bodyPreview:n.substring(0,100)},"Invalid JSON in request body"),new S("Invalid JSON in request body")}}if(r.includes("application/x-www-form-urlencoded")){let n=await s.text();if(n.length>t)throw new S("Payload too large");return Object.fromEntries(new URLSearchParams(n))}if(r.includes("multipart/form-data"))return await s.formData()}catch(n){throw n instanceof S?n:(e?.error({error:String(n)},"Error parsing request body"),new S("Failed to parse request body"))}return {}}function re(s){let e=new Map;if(!s)return e;let t=s.split(";");for(let r of t){let[n,...c]=r.trim().split("=");if(n){let d=c.join("=");e.set(n,d?decodeURIComponent(d):"");}}return e}function Q(s,e,t,r,n){let c=new URL(s.url),d=Object.fromEntries(c.searchParams),i=s.headers,l=200,y=new Map,b=re(i.get("cookie")||""),v={request:s,params:e,query:d,headers:i,db:t,logger:r,requestId:n,get statusCode(){return l},set statusCode(u){l=u;},body:null,json(u,p){return new Response(JSON.stringify(u),{status:p??l,headers:{"Content-Type":"application/json",...this._setCookieHeaders()}})},text(u,p){return new Response(u,{status:p??l,headers:{"Content-Type":"text/plain",...this._setCookieHeaders()}})},html(u,p){return new Response(u,{status:p??l,headers:{"Content-Type":"text/html; charset=utf-8",...this._setCookieHeaders()}})},redirect(u,p=302){return new Response(null,{status:p,headers:{Location:u,...this._setCookieHeaders()}})},file(u,p="application/octet-stream"){let g=Bun.file(u);return new Response(g,{headers:{"Content-Type":p,...this._setCookieHeaders()}})},setCookie(u,p,g={}){let m=`${u}=${encodeURIComponent(p)}`;return g.maxAge!==void 0&&(m+=`; Max-Age=${g.maxAge}`),g.expires&&(m+=`; Expires=${g.expires.toUTCString()}`),g.path&&(m+=`; Path=${g.path}`),g.domain&&(m+=`; Domain=${g.domain}`),g.secure&&(m+="; Secure"),g.httpOnly&&(m+="; HttpOnly"),g.sameSite&&(m+=`; SameSite=${g.sameSite}`),y.set(u,m),v},getCookie(u){return b.get(u)},deleteCookie(u,p={}){return v.setCookie(u,"",{...p,maxAge:0,path:p.path||"/"})},setHeader(u,p){return i.set(u,p),v},getHeader(u){return i.get(u)||void 0},status(u){return l=u,v},_setCookieHeaders(){let u={};return y.size>0&&(u["Set-Cookie"]=Array.from(y.values())),u}};return v}function ne(s){let e=s.headers.get("x-forwarded-for");if(e)return e.split(",").map(n=>n.trim())[0]||"unknown";let t=s.headers.get("x-real-ip");return t||"unknown"}function se(s,e){let t=new Headers;if(!e.security||typeof e.security!="object"||!e.security.cors)return t;let r=typeof e.security.cors=="object"?e.security.cors:{},n=s.headers.get("Origin");if(n){typeof r.origin=="function"?r.origin(n)&&t.set("Access-Control-Allow-Origin",n):Array.isArray(r.origin)?r.origin.includes(n)&&t.set("Access-Control-Allow-Origin",n):typeof r.origin=="string"?t.set("Access-Control-Allow-Origin",r.origin):t.set("Access-Control-Allow-Origin",n);let c=r.methods||["GET","POST","PUT","DELETE","PATCH","OPTIONS"];t.set("Access-Control-Allow-Methods",c.join(", "));let d=r.allowedHeaders||["Content-Type","Authorization","X-Requested-With"];t.set("Access-Control-Allow-Headers",d.join(", ")),r.credentials&&t.set("Access-Control-Allow-Credentials","true"),r.maxAge&&t.set("Access-Control-Max-Age",r.maxAge.toString());}return t}var me=ee;export{C as AppError,X as DatabaseError,I as Logger,B as RateLimitError,P as TimeoutError,S as ValidationError,me as default,ee as server};//# sourceMappingURL=main.js.map
//# sourceMappingURL=main.js.map